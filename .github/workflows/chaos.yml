name: Push

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

    - name: Creating kind cluster 
      uses: helm/kind-action@v1.0.0-rc.1

    - name: Print cluster information
      run: |
        kubectl config view
        kubectl cluster-info
        kubectl get nodes
        kubectl get pods -n kube-system
        helm version
        kubectl version

    - uses: actions/checkout@v2

    - name: Deploy an application
      run: |
        kubectl apply -f https://raw.githubusercontent.com/chaos-mesh/apps/master/ping-baidu/busybox-statefulset.yaml
        
    - name: Run chaos mesh action
      uses: WangXiangUSTC/chaos-mesh-actions@master
      env:
        CHAOS_KIND: NetworkChaos
        CHAOS_DURATION: 30
        APP_NAME: busybox
        CFG_BASE64: CmFwaVZlcnNpb246IGNoYW9zLW1lc2gub3JnL3YxYWxwaGExCmtpbmQ6IE5ldHdvcmtDaGFvcwptZXRhZGF0YToKICBuYW1lOiB3ZWItc2hvdy1uZXR3b3JrLWRlbGF5CnNwZWM6CiAgYWN0aW9uOiBkZWxheSAjIHRoZSBzcGVjaWZpYyBjaGFvcyBhY3Rpb24gdG8gaW5qZWN0CiAgbW9kZTogYWxsCiBzZWxlY3RvcjoKICAgcG9kczoKICAgICBidXN5Ym94OgogICAgICAgLSBidXN5Ym94LTAKIGRlbGF5OgogICBsYXRlbmN5OiAiMTBtcyIKIGRpcmVjdGlvbjogdG8KIHRhcmdldDoKICAgc2VsZWN0b3I6CiAgICAgcG9kczoKICAgICAgIGJ1c3lib3g6CiAgICAgICAgIC0gYnVzeWJveC0xCiAgIG1vZGU6IGFsbAo= 

    - name: Verify
      run: |
        echo "do some verify"
        kubectl exec busybox-0 -it -n busybox -- ping -c 30 busybox-1.busybox.busybox.svc
